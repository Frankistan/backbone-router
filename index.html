<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">

    <title>Backbone-router by citizen-media</title>
  </head>

  <body>

    <header>
      <div class="container">
        <h1>Backbone-router</h1>
        <h2>Routing Backbone with style \o/</h2>

        <section id="downloads">
          <a href="https://github.com/citizen-media/backbone-router/zipball/master" class="btn">Download as .zip</a>
          <a href="https://github.com/citizen-media/backbone-router/tarball/master" class="btn">Download as .tar.gz</a>
          <a href="https://github.com/citizen-media/backbone-router" class="btn btn-github"><span class="icon"></span>View on GitHub</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <p>This library wraps the <code>Backbone.Router</code> to simplify its use and bring new functionalities</p>

<p>Its structure and API is inspired by routers in the Node.js frameworks: Meteor and ExpressJS.</p>

<p>Added functionalities compared to the <code>Backbone.Router</code> are:</p>

<ul>
<li>Multiple controllers for the same path</li>
<li>Before and After triggers</li>
<li>Trigger caching</li>
<li>Aliasing</li>
<li>"Secured" routes</li>
</ul>

<h2>
<a id="installation" class="anchor" href="#installation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installation</h2>

<p>You can install the library via bower:</p>

<pre><code>bower install backbone-router
</code></pre>

<h2>
<a id="dependencies" class="anchor" href="#dependencies" aria-hidden="true"><span class="octicon octicon-link"></span></a>Dependencies</h2>

<p>The project has been renamed from marionette-router to backbone-router, because the <code>Backbone.Marionette</code> dependency has been removed. It now overrides the <code>Backbone.Router</code> namespace for simplicity.</p>

<p>The dependencies left are:</p>

<ul>
<li>Backbone 1.1.4</li>
<li>Underscore &gt;= 1.4.4 </li>
</ul>

<h2>
<a id="general-use" class="anchor" href="#general-use" aria-hidden="true"><span class="octicon octicon-link"></span></a>General use</h2>

<p>Declaring routes goes through executing a simple method: <code>Backbone.Router.map();</code></p>

<p>This method takes a function as its only parameter which will be executed in the router's context to access the internal API easily. A route consists of a unique name and an object to describe the route's action.</p>

<p>Let's just jump right in with an example:</p>

<div class="highlight highlight-javascript"><pre><span class="pl-c">// Create a marionette app instance</span>
<span class="pl-s">var</span> App <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">Backbone.Marionette</span>.Application();

<span class="pl-c">// Start route declarations</span>
Backbone.Router.map(<span class="pl-st">function</span>() {
  <span class="pl-c">// Declare a route named 'home'</span>
  <span class="pl-v">this</span>.route(<span class="pl-s1"><span class="pl-pds">"</span>home<span class="pl-pds">"</span></span>, {
    <span class="pl-c">// The url to which the route will respond</span>
    <span class="pl-s1"><span class="pl-pds">"</span>path<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s1"><span class="pl-pds">"</span>/<span class="pl-pds">"</span></span>,
    <span class="pl-c">// Method to be executed when the given path is intercepted</span>
    <span class="pl-s1"><span class="pl-pds">"</span><span class="pl-en">action</span><span class="pl-pds">"</span></span>: <span class="pl-st">function</span>() {
      <span class="pl-c">// Do something fantastic \o/</span>
    }
  });

  <span class="pl-c">// Declare other routes...</span>
});

<span class="pl-c">// Wait for document ready event</span>
$(<span class="pl-st">function</span>() {
  <span class="pl-c">// Start the marionette app</span>
  App.<span class="pl-sc">start</span>();

  <span class="pl-c">// Start the router passing the marionette app instance</span>
  Backbone.Router.<span class="pl-sc">start</span>(App);
});</pre></div>

<h2>
<a id="start-routing" class="anchor" href="#start-routing" aria-hidden="true"><span class="octicon octicon-link"></span></a>Start routing</h2>

<p>The router has to be started via the <code>start</code> method.</p>

<p>Parameters:</p>

<ul>
<li>App (Mixed) - Can be an instance of <code>Backbone.Marionette.Application</code> or a copy of <code>Backbone.Events</code>. Will be used to execute triggers declared in routes.</li>
<li>Options (Object) - Override default router configuration</li>
</ul>

<p>If given a Marionette app instance the router will use the <code>vent</code> global event aggregator to distribute route triggers.</p>

<p>Building on the previous script, here is an example:</p>

<div class="highlight highlight-javascript"><pre><span class="pl-c">// Create app</span>
<span class="pl-s">var</span> App <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">Backbone.Marionette</span>.Application();

<span class="pl-c">// Define some routes ...</span>

<span class="pl-c">// Start the marionette app</span>
App.<span class="pl-sc">start</span>();

<span class="pl-c">// Start the router passing the marionette app instance and an options object</span>
Backbone.Router.<span class="pl-sc">start</span>(App, {
  <span class="pl-c">// Root url for all routes, passed to Backbone.history</span>
  <span class="pl-s1"><span class="pl-pds">"</span>root<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s1"><span class="pl-pds">"</span>/admin<span class="pl-pds">"</span></span>,

  <span class="pl-c">// Activate html5 pushState or not, true by default</span>
  <span class="pl-s1"><span class="pl-pds">"</span>pushState<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">false</span>,

  <span class="pl-c">// Whether the user is currently logged in or not</span>
  <span class="pl-s1"><span class="pl-pds">"</span>authed<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">false</span>,

  <span class="pl-c">// If not logged in, redirect the user to a route named "login" (if it exists)</span>
  <span class="pl-s1"><span class="pl-pds">"</span>redirectToLogin<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">false</span>,

  <span class="pl-c">// Print out routing debug information to the console</span>
  <span class="pl-s1"><span class="pl-pds">"</span>debug<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">true</span>
});</pre></div>

<p>Or passing a <code>Backbone.Events</code> copy:</p>

<div class="highlight highlight-javascript"><pre><span class="pl-c">// Copy Backbone.Events</span>
<span class="pl-s">var</span> dispatcher <span class="pl-k">=</span> _.extend({}, Backbone.Events);

<span class="pl-c">// Start router</span>
Backbone.Router.<span class="pl-sc">start</span>(dispatcher);</pre></div>

<p>The dispatcher can also be overridden before the router is started in this way:</p>

<div class="highlight highlight-javascript"><pre>Backbone.Router.dispatcher <span class="pl-k">=</span> _.extend({}, Backbone.Events);</pre></div>

<h2>
<a id="router-go" class="anchor" href="#router-go" aria-hidden="true"><span class="octicon octicon-link"></span></a>Router go!</h2>

<p>To redirect the user to a certain route when, for example, he clicks a link simply use the <code>go</code> method.</p>

<div class="highlight highlight-javascript"><pre>Backbone.Router.<span class="pl-s3">go</span>(<span class="pl-s1"><span class="pl-pds">"</span>home<span class="pl-pds">"</span></span>);</pre></div>

<p><strong>Parameters</strong></p>

<ul>
<li>name (Mixed): The route name to execute or an object describing the route.</li>
<li>args (Mixed): Array of arguments, can also be a function's <code>arguments</code> object.</li>
<li>options (Object): Passed to the Backbone.Router navigate method. Defaults to <code>{ "trigger": true, "replace": false }</code>
</li>
</ul>

<p>Let's define a route that takes a parameter:</p>

<div class="highlight highlight-javascript"><pre>Backbone.Router.map(<span class="pl-st">function</span>() {
  <span class="pl-c">// Declare a user profile page</span>
  <span class="pl-v">this</span>.route(<span class="pl-s1"><span class="pl-pds">"</span>user_profile<span class="pl-pds">"</span></span>, {
    <span class="pl-s1"><span class="pl-pds">"</span>path<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s1"><span class="pl-pds">"</span>/user/:id<span class="pl-pds">"</span></span>,
    <span class="pl-s1"><span class="pl-pds">"</span><span class="pl-en">action</span><span class="pl-pds">"</span></span>: <span class="pl-st">function</span>(<span class="pl-vpf">userId</span>) {
      <span class="pl-c">// Render user profile page</span>
    }
  });
})</pre></div>

<p>Considering the current page contains a link like this:</p>

<div class="highlight highlight-javascript"><pre><span class="pl-k">&lt;</span>a href<span class="pl-k">=</span><span class="pl-s1"><span class="pl-pds">"</span>/user/42<span class="pl-pds">"</span></span> <span class="pl-st">class</span><span class="pl-k">=</span><span class="pl-s1"><span class="pl-pds">"</span>profile<span class="pl-pds">"</span></span> data<span class="pl-k">-</span>id<span class="pl-k">=</span><span class="pl-s1"><span class="pl-pds">"</span>42<span class="pl-pds">"</span></span><span class="pl-k">&gt;</span>Your profile<span class="pl-k">!&lt;</span>/a<span class="pl-k">&gt;</span></pre></div>

<p>We could write a script (using jquery) to redirect the user like so:</p>

<div class="highlight highlight-javascript"><pre><span class="pl-c">// Intercept the user click</span>
$(<span class="pl-s1"><span class="pl-pds">"</span>a.profile<span class="pl-pds">"</span></span>).<span class="pl-s3">click</span>(<span class="pl-st">function</span>(<span class="pl-vpf">e</span>) {
  e.preventDefault();

  <span class="pl-s">var</span> userId <span class="pl-k">=</span> $(<span class="pl-v">this</span>).attr(<span class="pl-s1"><span class="pl-pds">"</span>data-id<span class="pl-pds">"</span></span>);

  <span class="pl-c">// Redirecting to route named "user_profile" passing an id</span>
  Backbone.Router.<span class="pl-s3">go</span>(<span class="pl-s1"><span class="pl-pds">"</span>user_profile<span class="pl-pds">"</span></span>, [userId]);
});</pre></div>

<p>As the first parameter to the <code>go</code> method can be an object, we could also write the previous script in this manner:</p>

<div class="highlight highlight-javascript"><pre><span class="pl-c">// Intercept the user click</span>
$(<span class="pl-s1"><span class="pl-pds">"</span>a.profile<span class="pl-pds">"</span></span>).<span class="pl-s3">click</span>(<span class="pl-st">function</span>(<span class="pl-vpf">e</span>) {
  e.preventDefault();

  <span class="pl-c">// Redirecting to route using the path defined in the href attribute</span>
  Backbone.Router.<span class="pl-s3">go</span>({ <span class="pl-s1"><span class="pl-pds">"</span>path<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-v">this</span>.<span class="pl-sc">href</span> });
});</pre></div>

<h2>
<a id="route-declaration-parameters" class="anchor" href="#route-declaration-parameters" aria-hidden="true"><span class="octicon octicon-link"></span></a>Route declaration parameters</h2>

<p>The <code>path</code> and <code>action</code> parameters are the base of a route. But a few more parameters exist to extend the control of the route.</p>

<div class="highlight highlight-javascript"><pre><span class="pl-c">// Definition object for a route named 'user_edit'</span>
{
  <span class="pl-c">// Path with an 'id' parameter</span>
  <span class="pl-s1"><span class="pl-pds">"</span>path<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s1"><span class="pl-pds">"</span>/user/:id/edit<span class="pl-pds">"</span></span>,

  <span class="pl-c">// Route will only be executed if the user is logged in</span>
  <span class="pl-s1"><span class="pl-pds">"</span>authed<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">true</span>,

  <span class="pl-c">// Execute triggers before the 'action' controller</span>
  <span class="pl-s1"><span class="pl-pds">"</span>before<span class="pl-pds">"</span></span><span class="pl-k">:</span> [
    { <span class="pl-s1"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s1"><span class="pl-pds">"</span>core:display<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>cache<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">true</span> },
    <span class="pl-s1"><span class="pl-pds">"</span>users:display<span class="pl-pds">"</span></span>
  ],

  <span class="pl-c">// Main controller for the route</span>
  <span class="pl-s1"><span class="pl-pds">"</span><span class="pl-en">action</span><span class="pl-pds">"</span></span>: <span class="pl-st">function</span>(<span class="pl-vpf">userId</span>) {
    <span class="pl-c">// Render a user edit form</span>
  },

  <span class="pl-c">// Execute triggers after the 'action' controller</span>
  <span class="pl-s1"><span class="pl-pds">"</span>after<span class="pl-pds">"</span></span><span class="pl-k">:</span> [
    <span class="pl-s1"><span class="pl-pds">"</span>core:post_triggers<span class="pl-pds">"</span></span>
  ],

  <span class="pl-c">// Executed when user is routed away from this route</span>
  <span class="pl-s1"><span class="pl-pds">"</span><span class="pl-en">close</span><span class="pl-pds">"</span></span>: <span class="pl-st">function</span>() {
    <span class="pl-c">// Return false to cancel the routing</span>
    <span class="pl-k">return</span> <span class="pl-s3">confirm</span>(<span class="pl-s1"><span class="pl-pds">"</span>Are you sure you want to leave this page?<span class="pl-pds">"</span></span>);
  }
}</pre></div>

<h3>
<a id="catching-client-side-404-and-403" class="anchor" href="#catching-client-side-404-and-403" aria-hidden="true"><span class="octicon octicon-link"></span></a>Catching client-side 404 and 403</h3>

<p>A route named 404 can be declared to catch all non-existent routes.
In the same way a route can be named 403 to catch accessing restricted routes.</p>

<div class="highlight highlight-javascript"><pre>Backbone.Router.map(<span class="pl-st">function</span>() {
  <span class="pl-c">// 404 controller</span>
  <span class="pl-v">this</span>.route(<span class="pl-s1"><span class="pl-pds">"</span>404<span class="pl-pds">"</span></span>, {
    <span class="pl-s1"><span class="pl-pds">"</span><span class="pl-en">action</span><span class="pl-pds">"</span></span>: <span class="pl-st">function</span>(<span class="pl-vpf">path</span>) {
      <span class="pl-c">// Couldn't find what you're looking for =/</span>
    }
  });

  <span class="pl-c">// 403 controller</span>
  <span class="pl-v">this</span>.route(<span class="pl-s1"><span class="pl-pds">"</span>403<span class="pl-pds">"</span></span>, {
    <span class="pl-s1"><span class="pl-pds">"</span><span class="pl-en">action</span><span class="pl-pds">"</span></span>: <span class="pl-st">function</span>(<span class="pl-vpf">path</span>) {
      <span class="pl-c">// Sorry you can't access this content =(</span>
    }
  });
});</pre></div>

<p>For convenience, the action methods will receive the current <code>window.location.pathname</code> as the first argument.</p>

<p>The 404 controller will also be executed when a non-existent route is called with the <code>go</code> method.</p>

<p>The 403 controller will only be executed if the <code>redirectToLogin</code> option is set to <code>false</code>.</p>

<h2>
<a id="events-distribution-triggers" class="anchor" href="#events-distribution-triggers" aria-hidden="true"><span class="octicon octicon-link"></span></a>Events distribution (Triggers)</h2>

<p>To distribute the triggers declared in the <code>before</code> and <code>after</code> parameters the <code>Backbone.Router</code> uses the <code>Marionette</code> global event aggregator: <code>App.vent</code></p>

<p>This parameter can be overridden using any <code>Backbone.Events</code> instance.</p>

<div class="highlight highlight-javascript"><pre><span class="pl-s">var</span> App <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">Backbone.Marionette</span>.Application();

<span class="pl-c">// Create a custom event aggregator</span>
<span class="pl-s">var</span> myDispatcher <span class="pl-k">=</span> _.extend({}, Backbone.Events);

<span class="pl-c">// Pass the custom object to the Router</span>
Backbone.Router.dispatcher <span class="pl-k">=</span> myDispatcher;

App.<span class="pl-sc">start</span>();
Backbone.Router.<span class="pl-sc">start</span>(App);</pre></div>

<h2>
<a id="trigger-declaration" class="anchor" href="#trigger-declaration" aria-hidden="true"><span class="octicon octicon-link"></span></a>Trigger declaration</h2>

<p>Triggers can be declared in different ways.</p>

<p>They can be a simple <code>String</code> for the simple ones:</p>

<div class="highlight highlight-javascript"><pre>{
  <span class="pl-c">// ...</span>
  <span class="pl-s1"><span class="pl-pds">"</span>before<span class="pl-pds">"</span></span><span class="pl-k">:</span> [
    <span class="pl-s1"><span class="pl-pds">"</span>core<span class="pl-pds">"</span></span>,
    <span class="pl-s1"><span class="pl-pds">"</span>module<span class="pl-pds">"</span></span>,
    <span class="pl-s1"><span class="pl-pds">"</span>submodule<span class="pl-pds">"</span></span>
  ],
  <span class="pl-c">// ...</span>
}</pre></div>

<p>They can also be declared as an object with different parameters:</p>

<div class="highlight highlight-javascript"><pre>{
  <span class="pl-c">// ...</span>
  <span class="pl-s1"><span class="pl-pds">"</span>before<span class="pl-pds">"</span></span><span class="pl-k">:</span> [
    { <span class="pl-s1"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s1"><span class="pl-pds">"</span>core<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>cache<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">true</span> },
    { <span class="pl-s1"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s1"><span class="pl-pds">"</span>module<span class="pl-pds">"</span></span>, args<span class="pl-k">:</span> [foo, bar] },
    <span class="pl-s1"><span class="pl-pds">"</span>submodule<span class="pl-pds">"</span></span>
  ],
  <span class="pl-c">// ...</span>
}</pre></div>

<p><strong>Most importantly:</strong> Each declared route becomes a trigger itself so that routes can build on each other.</p>

<h2>
<a id="secured-routes" class="anchor" href="#secured-routes" aria-hidden="true"><span class="octicon octicon-link"></span></a>Secured routes</h2>

<p>Each route can receive an <code>authed</code> boolean parameter to declare if the route should be interpreted when the user is logged in or not.</p>

<div class="highlight highlight-javascript"><pre>Backbone.Router.map(<span class="pl-st">function</span>() {
  <span class="pl-c">// Declare secure route</span>
  <span class="pl-v">this</span>.route(<span class="pl-s1"><span class="pl-pds">"</span>secure_route<span class="pl-pds">"</span></span>, {
    <span class="pl-s1"><span class="pl-pds">"</span>path<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s1"><span class="pl-pds">"</span>/admin/users<span class="pl-pds">"</span></span>,
    <span class="pl-s1"><span class="pl-pds">"</span>authed<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">true</span>,
    <span class="pl-s1"><span class="pl-pds">"</span><span class="pl-en">action</span><span class="pl-pds">"</span></span>: <span class="pl-st">function</span>() {
      <span class="pl-c">// Display list of users</span>
    }
  });
});</pre></div>

<p>To make a route be interpreted in both cases (i.e. when the user is logged in or logged out),
simply leave out the <code>authed</code> parameter in the route declaration.</p>

<p><strong>Important</strong></p>

<p>Only the server has the authority to tell if a connected client is a logged in user or not.
So for this system to actually work, the server has to print out a small piece of JavaScript to tell the router the current client's state:</p>

<div class="highlight highlight-php"><pre><span class="pl-s2"><span class="pl-k">&lt;</span><span class="pl-c1">script</span> <span class="pl-c1">type</span><span class="pl-k">=</span><span class="pl-s1"><span class="pl-pds">"</span>text/javascript<span class="pl-pds">"</span></span> <span class="pl-c1">src</span><span class="pl-k">=</span><span class="pl-s1"><span class="pl-pds">"</span>backbone.router.js<span class="pl-pds">"</span></span><span class="pl-k">&gt;&lt;</span><span class="pl-k">/</span><span class="pl-c1">script</span><span class="pl-k">&gt;</span></span>
<span class="pl-s2"><span class="pl-k">&lt;</span><span class="pl-c1">script</span> <span class="pl-c1">type</span><span class="pl-k">=</span><span class="pl-s1"><span class="pl-pds">"</span>text/javascript<span class="pl-pds">"</span></span><span class="pl-k">&gt;</span></span>
<span class="pl-s2"><span class="pl-c1">window</span><span class="pl-k">.</span><span class="pl-c1">logged_in</span> <span class="pl-k">=</span> <span class="pl-k">&lt;</span>?<span class="pl-c1">php</span> <span class="pl-k">if</span> (<span class="pl-vo">$_SESSION</span>[<span class="pl-s1"><span class="pl-pds">'</span>logged_in<span class="pl-pds">'</span></span>]): </span><span class="pl-pse"><span class="pl-s2">?</span>&gt;</span>true<span class="pl-pse">&lt;?php</span><span class="pl-s2"> <span class="pl-k">else</span>: </span><span class="pl-pse"><span class="pl-s2">?</span>&gt;</span>false<span class="pl-pse">&lt;?php</span><span class="pl-s2"> <span class="pl-k">endif</span>; </span><span class="pl-pse"><span class="pl-s2">?</span>&gt;</span>;

$(funtion() {
  // Starting the marionette app
  App.start();

  // Starting the router telling it if the user is logged in or not
  Backbone.Router.start(App, {
    "authed": window.logged_in
  });
});
&lt;/<span class="pl-ent">script</span>&gt;</pre></div>

<h2>
<a id="example" class="anchor" href="#example" aria-hidden="true"><span class="octicon octicon-link"></span></a>Example</h2>

<p>An implementation example <code>index.php</code> file is available in the repository. To run it create an apache vhost or use any web server you like.</p>

<p>So that client-side routing can work, every request sent to the server must be answered with the same code,
therefore an <code>.htaccess</code> file activating mod_rewrite and redirecting all requests to the <code>index.php</code> file is also available in the repository.</p>
      </section>
    </div>

    
  </body>
</html>